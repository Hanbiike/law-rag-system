# Law RAG System

[üá¨üáß English version](README.md)

–í—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ Retrieval-Augmented Generation (RAG) –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤—É –ö—ã—Ä–≥—ã–∑—Å–∫–æ–π –†–µ—Å–ø—É–±–ª–∏–∫–∏ —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π Telegram-–±–æ—Ç–∞.

## ‚ú® –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

- **üîç –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫** –ø–æ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–º –¥–æ–∫—É–º–µ–Ω—Ç–∞–º —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –≤–µ–∫—Ç–æ—Ä–Ω—ã—Ö —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤
- **ü§ñ Telegram-–±–æ—Ç** –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å —Å–∏—Å—Ç–µ–º–æ–π
- **üìä –¢—Ä–∏ —Ä–µ–∂–∏–º–∞ –æ—Ç–≤–µ—Ç–∞**: 
  - **–ë–∞–∑–æ–≤—ã–π** (1 –∑–∞–ø—Ä–æ—Å) ‚Äî –±—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ + LLM –æ—Ç–≤–µ—Ç
  - **–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π** (2 –∑–∞–ø—Ä–æ—Å–∞) ‚Äî —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Å —É—Ç–æ—á–Ω—è—é—â–∏–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏
  - **–ü–æ–∏—Å–∫** (1 –∑–∞–ø—Ä–æ—Å) ‚Äî —Ç–æ–ª—å–∫–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Å—Ç–∞—Ç—å–∏ –±–µ–∑ LLM
- **üåê –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–≤—É—Ö —è–∑—ã–∫–æ–≤**: —Ä—É—Å—Å–∫–∏–π –∏ –∫—ã—Ä–≥—ã–∑—Å–∫–∏–π
- **üìÑ –ê–Ω–∞–ª–∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤** —Å –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:
  - PDF —Ñ–∞–π–ª—ã —á–µ—Ä–µ–∑ URL (–±–µ–∑ base64)
  - –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è/—Å–∫—Ä–∏–Ω—à–æ—Ç—ã –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- **‚ö° –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: singleton-–ø–∞—Ç—Ç–µ—Ä–Ω—ã, LRU-–∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ, lazy-loading
- **üíæ MySQL + Milvus**: —Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö –∏ –≤–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫

## üèó –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
law-rag-system/
‚îú‚îÄ‚îÄ aitools/                      # AI –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ embedder.py              # Singleton-—ç–º–±–µ–¥–¥–µ—Ä —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º
‚îÇ   ‚îî‚îÄ‚îÄ llm.py                   # Azure OpenAI –∫–ª–∏–µ–Ω—Ç (responses API)
‚îú‚îÄ‚îÄ bot/                          # Telegram-–±–æ—Ç
‚îÇ   ‚îú‚îÄ‚îÄ bot.py                   # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ –∑–∞–ø—É—Å–∫ –±–æ—Ç–∞
‚îÇ   ‚îú‚îÄ‚îÄ handlers.py              # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
‚îÇ   ‚îú‚îÄ‚îÄ keyboards.py             # –ö—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
‚îÇ   ‚îú‚îÄ‚îÄ messages.py              # –õ–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
‚îÇ   ‚îî‚îÄ‚îÄ states.py                # FSM —Å–æ—Å—Ç–æ—è–Ω–∏—è
‚îú‚îÄ‚îÄ confs/                        # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îÇ   ‚îî‚îÄ‚îÄ config.py                # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è + –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã
‚îú‚îÄ‚îÄ databases/                    # –†–∞–±–æ—Ç–∞ —Å –ë–î
‚îÇ   ‚îú‚îÄ‚îÄ db.py                    # MySQL (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –±–∞–ª–∞–Ω—Å)
‚îÇ   ‚îú‚îÄ‚îÄ milvus_db.py             # Milvus (–≤–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫)
‚îÇ   ‚îú‚îÄ‚îÄ milvus_init.py           # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Milvus
‚îÇ   ‚îî‚îÄ‚îÄ init.sql                 # SQL —Å—Ö–µ–º–∞
‚îú‚îÄ‚îÄ parser/                       # –ü–∞—Ä—Å–∏–Ω–≥ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (–û–û–ü)
‚îÇ   ‚îú‚îÄ‚îÄ document_parser.py       # DocumentParser (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ RU/KG)
‚îÇ   ‚îú‚îÄ‚îÄ vectorizer.py            # Vectorizer (—ç–º–±–µ–¥–¥–∏–Ω–≥–∏)
‚îÇ   ‚îú‚îÄ‚îÄ milvus_loader.py         # MilvusLoader (–∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö)
‚îÇ   ‚îú‚îÄ‚îÄ pipeline.py              # ParserPipeline (–ø–æ–ª–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å)
‚îÇ   ‚îú‚îÄ‚îÄ docx/                    # –†—É—Å—Å–∫–∏–µ DOCX —Ñ–∞–π–ª—ã
‚îÇ   ‚îî‚îÄ‚îÄ docx_kg/                 # –ö–∏—Ä–≥–∏–∑—Å–∫–∏–µ DOCX —Ñ–∞–π–ª—ã
‚îú‚îÄ‚îÄ searchers/                    # –õ–æ–≥–∏–∫–∞ –ø–æ–∏—Å–∫–∞
‚îÇ   ‚îî‚îÄ‚îÄ search.py                # ProLawRAGSearch (RAG pipeline)
‚îú‚îÄ‚îÄ main.py                       # CLI —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞
‚îú‚îÄ‚îÄ run_bot.py                    # –ó–∞–ø—É—Å–∫ Telegram-–±–æ—Ç–∞
‚îú‚îÄ‚îÄ law_rag_db.json              # –ë–∞–∑–∞ –∑–∞–∫–æ–Ω–æ–≤ (RU)
‚îú‚îÄ‚îÄ law_rag_db_kg.json           # –ë–∞–∑–∞ –∑–∞–∫–æ–Ω–æ–≤ (KG)
‚îú‚îÄ‚îÄ requirements.txt              # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îî‚îÄ‚îÄ .env                          # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
```

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

```bash
git clone https://github.com/Hanbiike/law-rag-system.git
cd law-rag-system
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ `.env`

```env
# Azure OpenAI Nano (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤)
AZURE_ENDPOINT_NANO=https://your-endpoint.openai.azure.com/
AZURE_OPENAI_API_KEY_NANO=your_api_key
AZURE_DEPLOYMENT_NANO=your_deployment_name
AZURE_API_VERSION_NANO=2025-03-01-preview

# Telegram Bot
TELEGRAM_BOT_TOKEN=your_bot_token

# MySQL (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é localhost)
DB_HOST=localhost
DB_USER=root
DB_PASSWORD=root
DB_NAME=law_rag_users
DB_PORT=8889
```

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ MySQL

**–£—Å—Ç–∞–Ω–æ–≤–∫–∞ MySQL:**

```bash
# macOS
brew install mysql
brew services start mysql

# Ubuntu/Debian
sudo apt update
sudo apt install mysql-server
sudo systemctl start mysql

# Windows
# –°–∫–∞—á–∞–π—Ç–µ –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Å https://dev.mysql.com/downloads/mysql/
```

**–°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**

```bash
# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ MySQL
mysql -u root -p
```

```sql
-- –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
CREATE DATABASE law_rag_users CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∏–∑–º–µ–Ω–∏—Ç–µ –ø–∞—Ä–æ–ª—å)
CREATE USER 'law_rag_user'@'localhost' IDENTIFIED BY '–≤–∞—à_–Ω–∞–¥–µ–∂–Ω—ã–π_–ø–∞—Ä–æ–ª—å';

-- –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤
GRANT ALL PRIVILEGES ON law_rag_users.* TO 'law_rag_user'@'localhost';
FLUSH PRIVILEGES;

-- –í—ã—Ö–æ–¥
EXIT;
```

**–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ö–µ–º—ã:**

```bash
# –ò–º–ø–æ—Ä—Ç —Å—Ö–µ–º—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
mysql -u law_rag_user -p law_rag_users < databases/init.sql
```

**–û–±–Ω–æ–≤–∏—Ç–µ `.env` –≤–∞—à–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏:**

```env
DB_HOST=localhost
DB_USER=law_rag_user
DB_PASSWORD=–≤–∞—à_–Ω–∞–¥–µ–∂–Ω—ã–π_–ø–∞—Ä–æ–ª—å
DB_NAME=law_rag_users
DB_PORT=3306
```

### 4. –ó–∞–ø—É—Å–∫

**Telegram-–±–æ—Ç:**
```bash
python run_bot.py
```

**CLI —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```bash
python main.py
```
## üìñ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### Telegram-–±–æ—Ç

–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç:
1. –í—ã–±—Ä–∞—Ç—å —è–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ (üá∑üá∫ –†—É—Å—Å–∫–∏–π / üá∞üá¨ –ö—ã—Ä–≥—ã–∑—á–∞)
2. –í—ã–±—Ä–∞—Ç—å —Ä–µ–∂–∏–º –æ—Ç–≤–µ—Ç–∞:
   - **üìù –ë–∞–∑–æ–≤—ã–π** ‚Äî –ø–æ–∏—Å–∫ + LLM –æ—Ç–≤–µ—Ç
   - **‚ö° –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π** ‚Äî —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π –≤–æ–ø—Ä–æ—Å–æ–≤
   - **üîç –ü–æ–∏—Å–∫** ‚Äî —Ç–æ–ª—å–∫–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Å—Ç–∞—Ç—å–∏
3. –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã –æ –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–µ
4. –ó–∞–≥—Ä—É–∂–∞—Ç—å PDF –¥–æ–∫—É–º–µ–Ω—Ç—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
5. –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è/—Å–∫—Ä–∏–Ω—à–æ—Ç—ã –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

**–°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–æ–≤:**
- **–¢–µ–∫—Å—Ç–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã:**
  - –ë–∞–∑–æ–≤—ã–π —Ä–µ–∂–∏–º: 1 –∑–∞–ø—Ä–æ—Å
  - –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π —Ä–µ–∂–∏–º: 2 –∑–∞–ø—Ä–æ—Å–∞
  - –†–µ–∂–∏–º –ø–æ–∏—Å–∫–∞: 1 –∑–∞–ø—Ä–æ—Å
- **–î–æ–∫—É–º–µ–Ω—Ç—ã/–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:**
  - –ë–∞–∑–æ–≤—ã–π —Ä–µ–∂–∏–º: 3 –∑–∞–ø—Ä–æ—Å–∞
  - –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π —Ä–µ–∂–∏–º: 9 –∑–∞–ø—Ä–æ—Å–æ–≤

### –ü—Ä–æ–≥—Ä–∞–º–º–Ω—ã–π API

```python
from searchers.search import ProLawRAGSearch
import asyncio

# –°–æ–∑–¥–∞–Ω–∏–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ (singleton-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è)
searcher = ProLawRAGSearch(top_k=3, n_llm_questions=3)

# –¢–µ–∫—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
response = asyncio.run(searcher.get_response_text(
    query="–ö–∞–∫–∏–µ –ø—Ä–∞–≤–∞ –∏–º–µ–µ—Ç —Ä–∞–±–æ—Ç–Ω–∏–∫ –ø—Ä–∏ —É–≤–æ–ª—å–Ω–µ–Ω–∏–∏?",
    type='pro',     # 'base', 'pro', –∏–ª–∏ 'search'
    lang='ru'       # 'ru' –∏–ª–∏ 'kg'
))

# –ê–Ω–∞–ª–∏–∑ PDF –¥–æ–∫—É–º–µ–Ω—Ç–∞ (—á–µ—Ä–µ–∑ URL)
file_url = "https://api.telegram.org/file/bot<TOKEN>/<file_path>"
response = asyncio.run(searcher.get_response_from_doc_text(
    query="–ó–∞–∫–æ–Ω–µ–Ω –ª–∏ –¥–∞–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç?",
    file_url=file_url,
    type='pro',
    lang='ru'
))

# –ê–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞
image_url = "https://api.telegram.org/file/bot<TOKEN>/<file_path>"
response = asyncio.run(searcher.get_response_from_image_text(
    query="–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —ç—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç",
    image_url=image_url,
    type='base',
    lang='ru'
))

```

## ‚ö° –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### Singleton-–ø–∞—Ç—Ç–µ—Ä–Ω—ã
- `QueryEmbedder` ‚Äî –º–æ–¥–µ–ª—å —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑
- `LLMHelper` ‚Äî Azure OpenAI –∫–ª–∏–µ–Ω—Ç –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
- `MilvusLawSearcher` ‚Äî —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –ë–î –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è

### LRU-–∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ü—Ä–æ–º–ø—Ç—ã –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–æ–ø—Ä–æ—Å–æ–≤ (`@lru_cache`)
- –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã Telegram-–±–æ—Ç–∞
- –†–∞—Å—á—ë—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∑–∞–ø—Ä–æ—Å–æ–≤

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤
- –°–∂–∞—Ç—ã–µ –ø—Ä–æ–º–ø—Ç—ã –±–µ–∑ –ª–∏—à–Ω–∏—Ö –ø—Ä–æ–±–µ–ª–æ–≤
- –°–∏—Å—Ç–µ–º–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã
- –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞
- **Pro —Ä–µ–∂–∏–º –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤**: –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º (–¥–æ 10√ó3√ó3=90 —Å—Ç–∞—Ç–µ–π)

### Lazy-loading
- Telegram-–±–æ—Ç: searcher –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—Ä–æ—Å–µ
- Embedder: –º–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏

## üìö –ü–∞—Ä—Å–∏–Ω–≥ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ë–î

### –ü–∞–π–ø–ª–∞–π–Ω –ø–∞—Ä—Å–µ—Ä–∞

–°–∏—Å—Ç–µ–º–∞ –≤–∫–ª—é—á–∞–µ—Ç –ø–æ–ª–Ω—ã–π –û–û–ü-–ø–∞–π–ø–ª–∞–π–Ω –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤:

```mermaid
flowchart TD
    A[DOCX –§–∞–π–ª—ã<br/>–†—É—Å—Å–∫–∏–π/–ö—ã—Ä–≥—ã–∑—Å–∫–∏–π] --> B[DocumentParser]
    B --> C{–Ø–∑—ã–∫?}
    
    C -->|–†—É—Å—Å–∫–∏–π| D1[–ü–∞—Ä—Å–∏–Ω–≥ —Å<br/>—Ä—É—Å—Å–∫–∏–º–∏ –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º–∏]
    C -->|–ö—ã—Ä–≥—ã–∑—Å–∫–∏–π| D2[–ü–∞—Ä—Å–∏–Ω–≥ —Å<br/>–∫—ã—Ä–≥—ã–∑—Å–∫–∏–º–∏ –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º–∏]
    
    D1 --> E[–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–µ–π<br/>+ –†–∞–∑–¥–µ–ª/–ì–ª–∞–≤–∞]
    D2 --> E
    
    E --> F[–û–±—ä–µ–∫—Ç—ã Article<br/>–°–ø–∏—Å–æ–∫]
    F --> G[Vectorizer]
    
    G --> H[SentenceTransformer<br/>Batch –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ]
    H --> I[–û–±—ä–µ–∫—Ç—ã<br/>VectorizedArticle]
    
    I --> J{–°–æ—Ö—Ä–∞–Ω–∏—Ç—å JSON?}
    J -->|–î–∞| K[–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤<br/>law_rag_db.json]
    J -->|–ù–µ—Ç| L[MilvusLoader]
    K --> L
    
    L --> M{–Ø–∑—ã–∫?}
    M -->|–†—É—Å—Å–∫–∏–π| N1[law_collection]
    M -->|–ö—ã—Ä–≥—ã–∑—Å–∫–∏–π| N2[law_collection_kg]
    
    N1 --> O[–°–æ–∑–¥–∞–Ω–∏–µ/–£–¥–∞–ª–µ–Ω–∏–µ<br/>–ö–æ–ª–ª–µ–∫—Ü–∏–∏]
    N2 --> O
    
    O --> P[–í—Å—Ç–∞–≤–∫–∞ —Å—Ç–∞—Ç–µ–π<br/>—Å –≤–µ–∫—Ç–æ—Ä–∞–º–∏]
    P --> Q[–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–ª–ª–µ–∫—Ü–∏–∏<br/>–≤ –ø–∞–º—è—Ç—å]
    Q --> R[–ì–æ—Ç–æ–≤–æ –¥–ª—è<br/>—Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞]
    
    style A fill:#e1f5ff
    style R fill:#c8e6c9
    style H fill:#fff9c4
    style P fill:#ffccbc
```

```python
# –ü–æ–ª–Ω—ã–π –ø–∞–π–ø–ª–∞–π–Ω (–ø–∞—Ä—Å–∏–Ω–≥ DOCX ‚Üí –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—è ‚Üí –∑–∞–≥—Ä—É–∑–∫–∞ –≤ Milvus)
from parser import ParserPipeline, PipelineConfig

config = PipelineConfig(
    ru_input_dir="parser/docx",
    kg_input_dir="parser/docx_kg",
    milvus_db_path="milvus_law_rag.db"
)

pipeline = ParserPipeline(config)
pipeline.process_all()  # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä—É—Å—Å–∫–∏—Ö –∏ –∫–∏—Ä–≥–∏–∑—Å–∫–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

```python
from parser import DocumentParser, Language, Vectorizer, MilvusLoader

# 1. –ü–∞—Ä—Å–∏–Ω–≥ DOCX —Ñ–∞–π–ª–æ–≤
parser = DocumentParser(Language.RUSSIAN, "parser/docx")
articles = parser.parse_directory(save_jsonl=True)

# 2. –í–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Å—Ç–∞—Ç–µ–π
vectorizer = Vectorizer()
vectorized = vectorizer.vectorize_articles(articles)
vectorizer.save_to_json(vectorized, "law_rag_db.json")

# 3. –ó–∞–≥—Ä—É–∑–∫–∞ –≤ Milvus
loader = MilvusLoader()
loader.setup_language_collection(Language.RUSSIAN, vectorized)
```

### –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Milvus

```bash
# –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö JSON —Ñ–∞–π–ª–æ–≤
python -m databases.milvus_init --from-json

# –ü–æ–ª–Ω—ã–π –ø–∞–π–ø–ª–∞–π–Ω (–ø–∞—Ä—Å–∏–Ω–≥ + –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—è + –∑–∞–≥—Ä—É–∑–∫–∞)
python -m databases.milvus_init --full-pipeline

# –° –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º–∏ –ø—É—Ç—è–º–∏
python -m databases.milvus_init --from-json \
  --ru-json law_rag_db.json \
  --kg-json law_rag_db_kg.json \
  --db-path milvus_law_rag.db
```

## üîß –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

### AI –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã (`aitools/`)

| –ú–æ–¥—É–ª—å | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|----------|
| `embedder.py` | Singleton-—ç–º–±–µ–¥–¥–µ—Ä –Ω–∞ –±–∞–∑–µ `google/embeddinggemma-300m`, –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ, batch processing |
| `llm.py` | Azure OpenAI –∫–ª–∏–µ–Ω—Ç —Å responses API (`responses.parse`, `responses.create`). –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ–∞–π–ª–æ–≤/–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —á–µ—Ä–µ–∑ URL |

### Telegram-–±–æ—Ç (`bot/`)

| –ú–æ–¥—É–ª—å | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|----------|
| `bot.py` | –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è aiogram, polling |
| `handlers.py` | –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥, —Ç–µ–∫—Å—Ç–∞, –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (PDF), –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π |
| `keyboards.py` | –ö—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ inline/reply –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã (3 —Ä–µ–∂–∏–º–∞ –æ—Ç–≤–µ—Ç–∞) |
| `messages.py` | –õ–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (RU/KG) |
| `states.py` | FSM —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |

### –ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (`databases/`)

| –ú–æ–¥—É–ª—å | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|----------|
| `db.py` | MySQL: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –±–∞–ª–∞–Ω—Å, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ |
| `milvus_db.py` | Milvus: –≤–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫ —Å –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–µ–π |
| `milvus_init.py` | –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Milvus –∏–∑ JSON –∏–ª–∏ –ø–æ–ª–Ω–æ–≥–æ –ø–∞–π–ø–ª–∞–π–Ω–∞ |

### –ü–∞—Ä—Å–µ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (`parser/`)

| –ú–æ–¥—É–ª—å | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|----------|
| `document_parser.py` | –û–û–ü-–ø–∞—Ä—Å–µ—Ä DOCX —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Ä—É—Å—Å–∫–æ–≥–æ/–∫–∏—Ä–≥–∏–∑—Å–∫–æ–≥–æ. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `Language` enum –∏ `PatternFactory` –¥–ª—è —è–∑—ã–∫–æ–≤—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ |
| `vectorizer.py` | –í–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Å SentenceTransformer. Batch processing, lazy-loading, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–∑–∞–≥—Ä—É–∑–∫–∞ JSON |
| `milvus_loader.py` | –ó–∞–≥—Ä—É–∑–∫–∞ –≤–µ–∫—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö —Å—Ç–∞—Ç–µ–π –≤ Milvus. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–ª–ª–µ–∫—Ü–∏—è–º–∏, –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –ø–æ —è–∑—ã–∫—É |
| `pipeline.py` | End-to-end –ø–∞–π–ø–ª–∞–π–Ω: –ø–∞—Ä—Å–∏–Ω–≥ ‚Üí –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—è ‚Üí –∑–∞–≥—Ä—É–∑–∫–∞. –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–æ–ª–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∏–ª–∏ —Ç–æ–ª—å–∫–æ JSON |

## üõ† –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ü—Ä–æ—Ü–µ—Å—Å RAG-–ø–æ–∏—Å–∫–∞

#### –¢–µ–∫—Å—Ç–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã

```mermaid
flowchart TD
    A[–ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è] --> B{–†–µ–∂–∏–º?}
    B -->|pro| C[LLM –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç<br/>—É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã]
    B -->|base/search| D[–ü—Ä—è–º–∞—è –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—è]
    C --> E[QueryEmbedder<br/>–≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—è]
    D --> E
    E --> F[Milvus –ø–æ–∏—Å–∫<br/>COSINE similarity]
    F --> G[–î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è<br/>—Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤]
    G --> H{–†–µ–∂–∏–º?}
    H -->|search| I[–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ<br/>—Å—Ç–∞—Ç–µ–π]
    H -->|base/pro| J[LLM –≥–µ–Ω–µ—Ä–∞—Ü–∏—è<br/>–æ—Ç–≤–µ—Ç–∞ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º]
    I --> K[–û—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é]
    J --> K
    
    style A fill:#e1f5ff
    style K fill:#c8e6c9
    style C fill:#fff9c4
    style J fill:#fff9c4
```

#### –î–æ–∫—É–º–µ–Ω—Ç—ã/–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è

```mermaid
flowchart TD
    A[–î–æ–∫—É–º–µ–Ω—Ç/–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ URL] --> B[LLM –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ<br/>–ø–∞—Ä–∞–≥—Ä–∞—Ñ–æ–≤]
    B --> C{–†–µ–∂–∏–º?}
    
    C -->|base| D1[–í–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—è<br/>–∫–∞–∂–¥–æ–≥–æ –ø–∞—Ä–∞–≥—Ä–∞—Ñ–∞]
    D1 --> D2[–ü–æ–∏—Å–∫ top_k<br/>–¥–ª—è –∫–∞–∂–¥–æ–≥–æ]
    D2 --> D3[–ö–æ–Ω—Ç–µ–∫—Å—Ç:<br/>paragraphs √ó top_k]
    
    C -->|pro| E1[–î–ª—è –ö–ê–ñ–î–û–ì–û –ø–∞—Ä–∞–≥—Ä–∞—Ñ–∞]
    E1 --> E2[–ì–µ–Ω–µ—Ä–∞—Ü–∏—è n –≤–æ–ø—Ä–æ—Å–æ–≤]
    E2 --> E3[–ü–æ–∏—Å–∫ top_k<br/>–¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞]
    E3 --> E4[–ö–æ–Ω—Ç–µ–∫—Å—Ç:<br/>paragraphs √ó n √ó top_k]
    
    D3 --> F[–î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è<br/>—Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤]
    E4 --> F
    F --> G[LLM –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç<br/>—Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç]
    G --> H[–û—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é]
    
    style A fill:#e1f5ff
    style H fill:#c8e6c9
    style B fill:#fff9c4
    style E2 fill:#fff9c4
    style G fill:#fff9c4
    style E4 fill:#ffccbc
```

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö Milvus

```
law_collection / law_collection_kg
‚îú‚îÄ‚îÄ source_doc     ‚Äî –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–∫–æ–Ω–∞
‚îú‚îÄ‚îÄ section        ‚Äî —Ä–∞–∑–¥–µ–ª
‚îú‚îÄ‚îÄ chapter        ‚Äî –≥–ª–∞–≤–∞
‚îú‚îÄ‚îÄ article_title  ‚Äî –Ω–∞–∑–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—å–∏
‚îú‚îÄ‚îÄ article_text   ‚Äî —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç—å–∏
‚îî‚îÄ‚îÄ vector         ‚Äî —ç–º–±–µ–¥–¥–∏–Ω–≥ (1024 dim)
```



## üì¶ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

```
openai>=1.0.0           # Azure OpenAI SDK (responses API)
pydantic>=2.0.0         # –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
pymilvus>=2.3.0         # –í–µ–∫—Ç–æ—Ä–Ω–∞—è –ë–î
sentence-transformers   # –≠–º–±–µ–¥–¥–∏–Ω–≥–∏
mysql-connector-python  # MySQL
aiogram>=3.3.0          # Telegram-–±–æ—Ç
python-dotenv           # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
aiofiles                # Async —Ñ–∞–π–ª–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
```

## üêõ –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫

| –ü—Ä–æ–±–ª–µ–º–∞ | –†–µ—à–µ–Ω–∏–µ |
|----------|---------|
| `Error calling LLM` | –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `.env`, —É–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –¥–µ–ø–ª–æ–π Azure –∞–∫—Ç–∏–≤–µ–Ω |
| `Milvus connection error` | –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ `milvus_law_rag.db` |
| `CUDA out of memory` | –ú–æ–¥–µ–ª—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—Å—è –Ω–∞ CPU |
| –ù–∏–∑–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ | –£–≤–µ–ª–∏—á—å—Ç–µ `top_k`, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–µ–∂–∏–º `pro` |
| –†–µ–∂–∏–º –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è | –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ë–î –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç `'search'` –≤ `response_type` |

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –û–ø–µ—Ä–∞—Ü–∏—è | –í—Ä–µ–º—è |
|----------|-------|
| –≠–º–±–µ–¥–¥–∏–Ω–≥ –∑–∞–ø—Ä–æ—Å–∞ | ~0.1-0.3 —Å–µ–∫ |
| –ü–æ–∏—Å–∫ –≤ Milvus | ~0.01-0.05 —Å–µ–∫ |
| –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ LLM | ~1-3 —Å–µ–∫ |
| –†–µ–∂–∏–º 'search' | ~0.2-0.5 —Å–µ–∫ |
| –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª (base) | ~2-4 —Å–µ–∫ |
| –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª (pro) | ~4-7 —Å–µ–∫ |
| **–î–æ–∫—É–º–µ–Ω—Ç base** | ~5-10 —Å–µ–∫ |
| **–î–æ–∫—É–º–µ–Ω—Ç pro** | ~15-30 —Å–µ–∫ (–≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑) |

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- ‚ö†Ô∏è –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∫–æ–º–º–∏—Ç—å—Ç–µ `.env` –≤ git
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–æ—Ç–∞—Ü–∏—é API-–∫–ª—é—á–µ–π
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ë–î —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- –í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤:
  - PDF: –º–∞–∫—Å. 20 –ú–ë
  - –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: –º–∞–∫—Å. 10 –ú–ë
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: PDF, JPEG, PNG, GIF, WebP

## üîÑ –ü–∞–π–ø–ª–∞–π–Ω –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

### –ï–∂–µ–¥–Ω–µ–≤–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–∫–æ–Ω–æ–≤ (–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)

–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–∞–π–ø–ª–∞–π–Ω –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–∑—ã –∑–∞–∫–æ–Ω–æ–≤:

```mermaid
flowchart TD
    A[–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è<br/>–ø—Ä–æ–≤–µ—Ä–∫–∞<br/>–ï–∂–µ–¥–Ω–µ–≤–Ω–æ 02:00] --> B{–ù–æ–≤—ã–µ –∑–∞–∫–æ–Ω—ã<br/>–¥–æ—Å—Ç—É–ø–Ω—ã?}
    
    B -->|–ù–µ—Ç| C[–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å<br/>–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ]
    B -->|–î–∞| D[–°–∫–∞—á–∞—Ç—å<br/>–Ω–æ–≤—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã]
    
    D --> E[–ü–∞–π–ø–ª–∞–π–Ω –ø–∞—Ä—Å–µ—Ä–∞]
    
    
    E --> K[LLM –ê–Ω–∞–ª–∏–∑<br/>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–≤–æ–¥–∫–∏]
    
    K --> L[–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞<br/>—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π<br/>–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º]
    
    L --> M1[–û—Ç–ø—Ä–∞–≤–∫–∞ RU<br/>–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º<br/>—á–µ—Ä–µ–∑ Telegram]
    L --> M2[–û—Ç–ø—Ä–∞–≤–∫–∞ KG<br/>–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º<br/>—á–µ—Ä–µ–∑ Telegram]
    
    M1 --> N[–ê–¥–º–∏–Ω –ª–æ–≥–∏<br/>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞]
    M2 --> N
    
    N --> O[–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ<br/>–∑–∞–≤–µ—Ä—à–µ–Ω–æ]
    
    style A fill:#e1f5ff
    style O fill:#c8e6c9
    style E fill:#fff9c4
    style K fill:#fff9c4
    style L fill:#ffe0b2
```

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- üïê –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–æ–≤—ã—Ö –∑–∞–∫–æ–Ω–æ–≤
- üì• –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∏–∑ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
- üîç –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
- ‚ö° –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ —Å—Ç–∞—Ç—å–∏)
- ü§ñ **LLM-–∞–Ω–∞–ª–∏–∑ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ —Å–≤–æ–¥–æ–∫ –Ω–æ–≤—ã—Ö –∑–∞–∫–æ–Ω–æ–≤**
- üì¢ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —á–µ—Ä–µ–∑ Telegram-–±–æ—Ç**
- üí¨ **–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è –Ω–∞ —è–∑—ã–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (RU/KG)**
- üìä –õ–æ–≥–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
- üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–µ–∑ –ø—Ä–æ—Å—Ç–æ—è
- üåê –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —è–∑—ã–∫–æ–≤ (RU/KG)

## üß† –ü–∞–º—è—Ç—å –±–æ—Ç–∞ —Å Conversations API (–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)

### –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –º–µ–∂–¥—É —Å–µ–∞–Ω—Å–∞–º–∏

–†–µ–∞–ª–∏–∑–∞—Ü–∏—è OpenAI Conversations API –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞:

```mermaid
flowchart TD
    A[–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—á–∏–Ω–∞–µ—Ç<br/>–¥–∏–∞–ª–æ–≥] --> B{–î–∏–∞–ª–æ–≥<br/>—Å—É—â–µ—Å—Ç–≤—É–µ—Ç?}
    
    B -->|–ù–µ—Ç| C[–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π<br/>Conversation –æ–±—ä–µ–∫—Ç]
    B -->|–î–∞| D[–ó–∞–≥—Ä—É–∑–∏—Ç—å<br/>—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –¥–∏–∞–ª–æ–≥]
    
    C --> E[–°–æ—Ö—Ä–∞–Ω–∏—Ç—å conversation_id<br/>–≤ –ë–î –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è]
    D --> E
    
    style A fill:#e1f5ff
    style C fill:#fff9c4
```

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- üíæ **–ü–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞** –º–µ–∂–¥—É —Å–µ–∞–Ω—Å–∞–º–∏ –∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏
- üîÑ **–î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã –¥–∏–∞–ª–æ–≥–æ–≤** —Å –Ω–∞–¥–µ–∂–Ω—ã–º–∏ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞–º–∏
- üìù **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º** - –Ω–µ –Ω—É–∂–Ω–æ –≤—Ä—É—á–Ω—É—é —Å–≤—è–∑—ã–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è
- üéØ **–ú–Ω–æ–≥–æ—ç—Ç–∞–ø–Ω—ã–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è** —Å –ø–æ–ª–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–µ–π –¥–∏–∞–ª–æ–≥–∞
- üì± **–ù–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ—Å—Ç—å –º–µ–∂–¥—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏** - –ø—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –¥–∏–∞–ª–æ–≥ –≥–¥–µ —É–≥–æ–¥–Ω–æ
- üóÇÔ∏è **–•—Ä–∞–Ω–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–∏–∞–ª–æ–≥–∞** - —Å–æ–æ–±—â–µ–Ω–∏—è, –≤—ã–∑–æ–≤—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤, —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
- ‚ö° **–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞** - —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π OpenAI

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è API:**
```python
# –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞
conversation = openai.conversations.create()

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö –æ—Ç–≤–µ—Ç–∞—Ö
response = openai.responses.create(
    model="gpt-4.1",
    input=[{"role": "user", "content": "–ß—Ç–æ —Ç–∞–∫–æ–µ –º–µ–¥–∏–∞—Ü–∏—è?"}],
    conversation=conversation.id
)

# –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞
response2 = openai.responses.create(
    model="gpt-4.1",
    input=[{"role": "user", "content": "–ö–∞–∫–∏–µ —Å—Ç–∞—Ç—å–∏ —Ä–µ–≥—É–ª–∏—Ä—É—é—Ç —ç—Ç–æ?"}],
    conversation=conversation.id  # –¢–æ—Ç –∂–µ ID –¥–∏–∞–ª–æ–≥–∞
)
```

### –ü–æ—á–µ–º—É –Ω–µ `previous_response_id`?

**–ü—Ä–æ–±–ª–µ–º–∞ —Å —á–µ–π–Ω–∏–Ω–≥–æ–º –æ—Ç–≤–µ—Ç–æ–≤:**

![Context Window Problem](https://github.com/Hanbiike/law-rag-system/blob/main/context-window.png?raw=true)

**‚ö†Ô∏è –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –±–∏–ª–ª–∏–Ω–≥–∞:**

**–î–∞–∂–µ –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ `previous_response_id`, –≤—Å–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –≤—Ö–æ–¥–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤ –≤ —Ü–µ–ø–æ—á–∫–µ –æ–ø–ª–∞—á–∏–≤–∞—é—Ç—Å—è –∫–∞–∫ –≤—Ö–æ–¥–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã –≤ API.**

–≠—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫:
- üìà **–≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–º—É —Ä–æ—Å—Ç—É —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Ç–æ–∫–µ–Ω–æ–≤** —Å –∫–∞–∂–¥—ã–º —Ö–æ–¥–æ–º
- üí∞ **–ë–æ–ª–µ–µ –≤—ã—Å–æ–∫–∏–º —Å—á–µ—Ç–∞–º API** –¥–ª—è –º–Ω–æ–≥–æ—ç—Ç–∞–ø–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤
- üîÑ **–ò–∑–±—ã—Ç–æ—á–Ω–æ–π –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞** –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ
- ‚è±Ô∏è **–ó–∞–º–µ–¥–ª–µ–Ω–∏—é –æ—Ç–≤–µ—Ç–æ–≤** –∏–∑-–∑–∞ –±–æ–ª—å—à–∏—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã—Ö –æ–∫–æ–Ω

**–†–µ—à–µ–Ω–∏–µ: Conversations API**
- ‚úÖ –ö–æ–Ω—Ç–µ–∫—Å—Ç —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π OpenAI
- ‚úÖ –û–ø–ª–∞—Ç–∞ —Ç–æ–ª—å–∫–æ –∑–∞ –Ω–æ–≤—ã–µ —Ç–æ–∫–µ–Ω—ã, –∞ –Ω–µ –∑–∞ –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é
- ‚úÖ –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º
- ‚úÖ –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤

## üó∫ Roadmap

- [x] Telegram-–±–æ—Ç —Å FSM
- [x] –¢—Ä–∏ —Ä–µ–∂–∏–º–∞ –æ—Ç–≤–µ—Ç–∞ (base, pro, search)
- [x] –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π/—Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤
- [x] –†–∞–±–æ—Ç–∞ —Å —Ñ–∞–π–ª–∞–º–∏ —á–µ—Ä–µ–∑ URL (–±–µ–∑ base64)
- [x] Singleton-–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- [x] LRU-–∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
- [x] –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- [x] –û–û–ü-–ø–∞—Ä—Å–µ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- [ ] **–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–∞–π–ø–ª–∞–π–Ω –µ–∂–µ–¥–Ω–µ–≤–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∑–∞–∫–æ–Ω–æ–≤** üöß
- [ ] **–ü–∞–º—è—Ç—å –±–æ—Ç–∞ —Å Conversations API** üöß
- [ ] Redis –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–æ–≤
- [ ] Web –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (FastAPI)
- [ ] –ü–æ–¥–¥–µ—Ä–∂–∫–∞ DOCX –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- [ ] A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–µ–π
- [ ] –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–µ–∂–∏–º–æ–≤

## üìÑ –õ–∏—Ü–µ–Ω–∑–∏—è

GNU General Public License v3.0 (GPL-3.0)

–≠—Ç–æ —Å–≤–æ–±–æ–¥–Ω–æ–µ –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–µ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ: –≤—ã –º–æ–∂–µ—Ç–µ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è—Ç—å –∏/–∏–ª–∏ –∏–∑–º–µ–Ω—è—Ç—å –µ–≥–æ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å —É—Å–ª–æ–≤–∏—è–º–∏ GNU General Public License –≤–µ—Ä—Å–∏–∏ 3, –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω–æ–π Free Software Foundation.

–û—Å–Ω–æ–≤–Ω—ã–µ —É—Å–ª–æ–≤–∏—è:
- ‚úÖ –ö–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
- ‚úÖ –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è
- ‚úÖ –†–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ
- ‚úÖ –ü–∞—Ç–µ–Ω—Ç–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
- ‚úÖ –ß–∞—Å—Ç–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
- ‚ùó –†–∞—Å–∫—Ä—ã—Ç–∏–µ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∫–æ–¥–∞ (copyleft)
- ‚ùó –£–∫–∞–∑–∞–Ω–∏–µ –ª–∏—Ü–µ–Ω–∑–∏–∏ –∏ –∞–≤—Ç–æ—Ä—Å–∫–∏—Ö –ø—Ä–∞–≤
- ‚ùó –£–∫–∞–∑–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
- ‚ùó –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–æ–π –∂–µ –ª–∏—Ü–µ–Ω–∑–∏–∏

–°–º. [LICENSE](LICENSE) –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –ª–∏—Ü–µ–Ω–∑–∏–∏.

## üë§ –ê–≤—Ç–æ—Ä

**Askat Rakhymbekov** ([@Hanbiike](https://github.com/Hanbiike))

## üôè –ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏

- Azure OpenAI ‚Äî LLM –º–æ–¥–µ–ª–∏
- Milvus ‚Äî –≤–µ–∫—Ç–æ—Ä–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- SentenceTransformers ‚Äî —ç–º–±–µ–¥–¥–∏–Ω–≥–∏
- aiogram ‚Äî Telegram-–±–æ—Ç —Ñ—Ä–µ–π–º–≤–æ—Ä–∫