# Law RAG System

[üá¨üáß English version](README.md)

–í—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ Retrieval-Augmented Generation (RAG) –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤—É –ö—ã—Ä–≥—ã–∑—Å–∫–æ–π –†–µ—Å–ø—É–±–ª–∏–∫–∏ —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π Telegram-–±–æ—Ç–∞.

## ‚ú® –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

- **üîç –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫** –ø–æ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–º –¥–æ–∫—É–º–µ–Ω—Ç–∞–º —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –≤–µ–∫—Ç–æ—Ä–Ω—ã—Ö —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤
- **ü§ñ Telegram-–±–æ—Ç** –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å —Å–∏—Å—Ç–µ–º–æ–π
- **üìä –¢—Ä–∏ —Ä–µ–∂–∏–º–∞ –æ—Ç–≤–µ—Ç–∞**: 
  - **–ë–∞–∑–æ–≤—ã–π** (1 –∑–∞–ø—Ä–æ—Å) ‚Äî –±—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ + LLM –æ—Ç–≤–µ—Ç
  - **–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π** (2 –∑–∞–ø—Ä–æ—Å–∞) ‚Äî —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Å —É—Ç–æ—á–Ω—è—é—â–∏–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏
  - **–ü–æ–∏—Å–∫** (1 –∑–∞–ø—Ä–æ—Å) ‚Äî —Ç–æ–ª—å–∫–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Å—Ç–∞—Ç—å–∏ –±–µ–∑ LLM
- **üåê –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–≤—É—Ö —è–∑—ã–∫–æ–≤**: —Ä—É—Å—Å–∫–∏–π –∏ –∫—ã—Ä–≥—ã–∑—Å–∫–∏–π
- **üìÑ –ê–Ω–∞–ª–∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤** —Å –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:
  - PDF —Ñ–∞–π–ª—ã —á–µ—Ä–µ–∑ URL (–±–µ–∑ base64)
  - –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è/—Å–∫—Ä–∏–Ω—à–æ—Ç—ã –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- **‚ö° –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: singleton-–ø–∞—Ç—Ç–µ—Ä–Ω—ã, LRU-–∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ, lazy-loading
- **üíæ MySQL + Milvus**: —Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö –∏ –≤–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫

## üèó –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
law-rag-system/
‚îú‚îÄ‚îÄ aitools/                      # AI –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ embedder.py              # Singleton-—ç–º–±–µ–¥–¥–µ—Ä —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º
‚îÇ   ‚îî‚îÄ‚îÄ llm.py                   # Azure OpenAI –∫–ª–∏–µ–Ω—Ç (responses API)
‚îú‚îÄ‚îÄ bot/                          # Telegram-–±–æ—Ç
‚îÇ   ‚îú‚îÄ‚îÄ bot.py                   # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ –∑–∞–ø—É—Å–∫ –±–æ—Ç–∞
‚îÇ   ‚îú‚îÄ‚îÄ handlers.py              # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
‚îÇ   ‚îú‚îÄ‚îÄ keyboards.py             # –ö—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
‚îÇ   ‚îú‚îÄ‚îÄ messages.py              # –õ–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
‚îÇ   ‚îî‚îÄ‚îÄ states.py                # FSM —Å–æ—Å—Ç–æ—è–Ω–∏—è
‚îú‚îÄ‚îÄ confs/                        # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îÇ   ‚îî‚îÄ‚îÄ config.py                # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è + –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã
‚îú‚îÄ‚îÄ databases/                    # –†–∞–±–æ—Ç–∞ —Å –ë–î
‚îÇ   ‚îú‚îÄ‚îÄ db.py                    # MySQL (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –±–∞–ª–∞–Ω—Å)
‚îÇ   ‚îú‚îÄ‚îÄ milvus_db.py             # Milvus (–≤–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫)
‚îÇ   ‚îî‚îÄ‚îÄ init.sql                 # SQL —Å—Ö–µ–º–∞
‚îú‚îÄ‚îÄ searchers/                    # –õ–æ–≥–∏–∫–∞ –ø–æ–∏—Å–∫–∞
‚îÇ   ‚îî‚îÄ‚îÄ search.py                # ProLawRAGSearch (RAG pipeline)
‚îú‚îÄ‚îÄ main.py                       # CLI —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞
‚îú‚îÄ‚îÄ run_bot.py                    # –ó–∞–ø—É—Å–∫ Telegram-–±–æ—Ç–∞
‚îú‚îÄ‚îÄ law_rag_db.json              # –ë–∞–∑–∞ –∑–∞–∫–æ–Ω–æ–≤ (RU)
‚îú‚îÄ‚îÄ law_rag_db_kg.json           # –ë–∞–∑–∞ –∑–∞–∫–æ–Ω–æ–≤ (KG)
‚îú‚îÄ‚îÄ requirements.txt              # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îî‚îÄ‚îÄ .env                          # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
```

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

```bash
git clone https://github.com/Hanbiike/law-rag-system.git
cd law-rag-system
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ `.env`

```env
# Azure OpenAI Nano (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤)
AZURE_ENDPOINT_NANO=https://your-endpoint.openai.azure.com/
AZURE_OPENAI_API_KEY_NANO=your_api_key
AZURE_DEPLOYMENT_NANO=your_deployment_name
AZURE_API_VERSION_NANO=2025-03-01-preview

# Telegram Bot
TELEGRAM_BOT_TOKEN=your_bot_token

# MySQL (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é localhost)
DB_HOST=localhost
DB_USER=root
DB_PASSWORD=root
DB_NAME=law_rag_users
DB_PORT=8889
```

### 3. –ó–∞–ø—É—Å–∫

**Telegram-–±–æ—Ç:**
```bash
python run_bot.py
```

**CLI —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```bash
python main.py
```
## üìñ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### Telegram-–±–æ—Ç

–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç:
1. –í—ã–±—Ä–∞—Ç—å —è–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ (üá∑üá∫ –†—É—Å—Å–∫–∏–π / üá∞üá¨ –ö—ã—Ä–≥—ã–∑—á–∞)
2. –í—ã–±—Ä–∞—Ç—å —Ä–µ–∂–∏–º –æ—Ç–≤–µ—Ç–∞:
   - **üìù –ë–∞–∑–æ–≤—ã–π** ‚Äî –ø–æ–∏—Å–∫ + LLM –æ—Ç–≤–µ—Ç
   - **‚ö° –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π** ‚Äî —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π –≤–æ–ø—Ä–æ—Å–æ–≤
   - **üîç –ü–æ–∏—Å–∫** ‚Äî —Ç–æ–ª—å–∫–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Å—Ç–∞—Ç—å–∏
3. –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã –æ –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–µ
4. –ó–∞–≥—Ä—É–∂–∞—Ç—å PDF –¥–æ–∫—É–º–µ–Ω—Ç—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
5. –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è/—Å–∫—Ä–∏–Ω—à–æ—Ç—ã –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

**–°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–æ–≤:**
- **–¢–µ–∫—Å—Ç–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã:**
  - –ë–∞–∑–æ–≤—ã–π —Ä–µ–∂–∏–º: 1 –∑–∞–ø—Ä–æ—Å
  - –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π —Ä–µ–∂–∏–º: 2 –∑–∞–ø—Ä–æ—Å–∞
  - –†–µ–∂–∏–º –ø–æ–∏—Å–∫–∞: 1 –∑–∞–ø—Ä–æ—Å
- **–î–æ–∫—É–º–µ–Ω—Ç—ã/–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:**
  - –ë–∞–∑–æ–≤—ã–π —Ä–µ–∂–∏–º: 3 –∑–∞–ø—Ä–æ—Å–∞
  - –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π —Ä–µ–∂–∏–º: 9 –∑–∞–ø—Ä–æ—Å–æ–≤

### –ü—Ä–æ–≥—Ä–∞–º–º–Ω—ã–π API

```python
from searchers.search import ProLawRAGSearch
import asyncio

# –°–æ–∑–¥–∞–Ω–∏–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ (singleton-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è)
searcher = ProLawRAGSearch(top_k=3, n_llm_questions=3)

# –¢–µ–∫—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
response = asyncio.run(searcher.get_response_text(
    query="–ö–∞–∫–∏–µ –ø—Ä–∞–≤–∞ –∏–º–µ–µ—Ç —Ä–∞–±–æ—Ç–Ω–∏–∫ –ø—Ä–∏ —É–≤–æ–ª—å–Ω–µ–Ω–∏–∏?",
    type='pro',     # 'base', 'pro', –∏–ª–∏ 'search'
    lang='ru'       # 'ru' –∏–ª–∏ 'kg'
))

# –ê–Ω–∞–ª–∏–∑ PDF –¥–æ–∫—É–º–µ–Ω—Ç–∞ (—á–µ—Ä–µ–∑ URL)
file_url = "https://api.telegram.org/file/bot<TOKEN>/<file_path>"
response = asyncio.run(searcher.get_response_from_doc_text(
    query="–ó–∞–∫–æ–Ω–µ–Ω –ª–∏ –¥–∞–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç?",
    file_url=file_url,
    type='pro',
    lang='ru'
))

# –ê–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞
image_url = "https://api.telegram.org/file/bot<TOKEN>/<file_path>"
response = asyncio.run(searcher.get_response_from_image_text(
    query="–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —ç—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç",
    image_url=image_url,
    type='base',
    lang='ru'
))

```

## ‚ö° –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### Singleton-–ø–∞—Ç—Ç–µ—Ä–Ω—ã
- `QueryEmbedder` ‚Äî –º–æ–¥–µ–ª—å —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑
- `LLMHelper` ‚Äî Azure OpenAI –∫–ª–∏–µ–Ω—Ç –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
- `MilvusLawSearcher` ‚Äî —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –ë–î –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è

### LRU-–∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ü—Ä–æ–º–ø—Ç—ã –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–æ–ø—Ä–æ—Å–æ–≤ (`@lru_cache`)
- –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã Telegram-–±–æ—Ç–∞
- –†–∞—Å—á—ë—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∑–∞–ø—Ä–æ—Å–æ–≤

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤
- –°–∂–∞—Ç—ã–µ –ø—Ä–æ–º–ø—Ç—ã –±–µ–∑ –ª–∏—à–Ω–∏—Ö –ø—Ä–æ–±–µ–ª–æ–≤
- –°–∏—Å—Ç–µ–º–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã
- –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞
- **Pro —Ä–µ–∂–∏–º –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤**: –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º (–¥–æ 10√ó3√ó3=90 —Å—Ç–∞—Ç–µ–π)

### Lazy-loading
- Telegram-–±–æ—Ç: searcher –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—Ä–æ—Å–µ
- Embedder: –º–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏

## üîß –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

### AI –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã (`aitools/`)

| –ú–æ–¥—É–ª—å | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|----------|
| `embedder.py` | Singleton-—ç–º–±–µ–¥–¥–µ—Ä –Ω–∞ –±–∞–∑–µ `google/embeddinggemma-300m`, –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ, batch processing |
| `llm.py` | Azure OpenAI –∫–ª–∏–µ–Ω—Ç —Å responses API (`responses.parse`, `responses.create`). –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ–∞–π–ª–æ–≤/–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —á–µ—Ä–µ–∑ URL |

### Telegram-–±–æ—Ç (`bot/`)

| –ú–æ–¥—É–ª—å | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|----------|
| `bot.py` | –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è aiogram, polling |
| `handlers.py` | –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥, —Ç–µ–∫—Å—Ç–∞, –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (PDF), –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π |
| `keyboards.py` | –ö—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ inline/reply –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã (3 —Ä–µ–∂–∏–º–∞ –æ—Ç–≤–µ—Ç–∞) |
| `messages.py` | –õ–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (RU/KG) |
| `states.py` | FSM —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |

### –ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (`databases/`)

| –ú–æ–¥—É–ª—å | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|----------|
| `db.py` | MySQL: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –±–∞–ª–∞–Ω—Å, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ |
| `milvus_db.py` | Milvus: –≤–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫ —Å –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–µ–π |

## üõ† –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ü—Ä–æ—Ü–µ—Å—Å RAG-–ø–æ–∏—Å–∫–∞

#### –¢–µ–∫—Å—Ç–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã

```mermaid
flowchart TD
    A[–ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è] --> B{–†–µ–∂–∏–º?}
    B -->|pro| C[LLM –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç<br/>—É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã]
    B -->|base/search| D[–ü—Ä—è–º–∞—è –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—è]
    C --> E[QueryEmbedder<br/>–≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—è]
    D --> E
    E --> F[Milvus –ø–æ–∏—Å–∫<br/>COSINE similarity]
    F --> G[–î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è<br/>—Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤]
    G --> H{–†–µ–∂–∏–º?}
    H -->|search| I[–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ<br/>—Å—Ç–∞—Ç–µ–π]
    H -->|base/pro| J[LLM –≥–µ–Ω–µ—Ä–∞—Ü–∏—è<br/>–æ—Ç–≤–µ—Ç–∞ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º]
    I --> K[–û—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é]
    J --> K
    
    style A fill:#e1f5ff
    style K fill:#c8e6c9
    style C fill:#fff9c4
    style J fill:#fff9c4
```

#### –î–æ–∫—É–º–µ–Ω—Ç—ã/–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è

```mermaid
flowchart TD
    A[–î–æ–∫—É–º–µ–Ω—Ç/–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ URL] --> B[LLM –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ<br/>–ø–∞—Ä–∞–≥—Ä–∞—Ñ–æ–≤]
    B --> C{–†–µ–∂–∏–º?}
    
    C -->|base| D1[–í–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—è<br/>–∫–∞–∂–¥–æ–≥–æ –ø–∞—Ä–∞–≥—Ä–∞—Ñ–∞]
    D1 --> D2[–ü–æ–∏—Å–∫ top_k<br/>–¥–ª—è –∫–∞–∂–¥–æ–≥–æ]
    D2 --> D3[–ö–æ–Ω—Ç–µ–∫—Å—Ç:<br/>paragraphs √ó top_k]
    
    C -->|pro| E1[–î–ª—è –ö–ê–ñ–î–û–ì–û –ø–∞—Ä–∞–≥—Ä–∞—Ñ–∞]
    E1 --> E2[–ì–µ–Ω–µ—Ä–∞—Ü–∏—è n –≤–æ–ø—Ä–æ—Å–æ–≤]
    E2 --> E3[–ü–æ–∏—Å–∫ top_k<br/>–¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞]
    E3 --> E4[–ö–æ–Ω—Ç–µ–∫—Å—Ç:<br/>paragraphs √ó n √ó top_k]
    
    D3 --> F[–î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è<br/>—Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤]
    E4 --> F
    F --> G[LLM –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç<br/>—Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç]
    G --> H[–û—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é]
    
    style A fill:#e1f5ff
    style H fill:#c8e6c9
    style B fill:#fff9c4
    style E2 fill:#fff9c4
    style G fill:#fff9c4
    style E4 fill:#ffccbc
```

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö Milvus

```
law_collection / law_collection_kg
‚îú‚îÄ‚îÄ source_doc     ‚Äî –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–∫–æ–Ω–∞
‚îú‚îÄ‚îÄ section        ‚Äî —Ä–∞–∑–¥–µ–ª
‚îú‚îÄ‚îÄ chapter        ‚Äî –≥–ª–∞–≤–∞
‚îú‚îÄ‚îÄ article_title  ‚Äî –Ω–∞–∑–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—å–∏
‚îú‚îÄ‚îÄ article_text   ‚Äî —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç—å–∏
‚îî‚îÄ‚îÄ vector         ‚Äî —ç–º–±–µ–¥–¥–∏–Ω–≥ (1024 dim)
```



## üì¶ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

```
openai>=1.0.0           # Azure OpenAI SDK (responses API)
pydantic>=2.0.0         # –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
pymilvus>=2.3.0         # –í–µ–∫—Ç–æ—Ä–Ω–∞—è –ë–î
sentence-transformers   # –≠–º–±–µ–¥–¥–∏–Ω–≥–∏
mysql-connector-python  # MySQL
aiogram>=3.3.0          # Telegram-–±–æ—Ç
python-dotenv           # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
aiofiles                # Async —Ñ–∞–π–ª–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
```

## üêõ –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫

| –ü—Ä–æ–±–ª–µ–º–∞ | –†–µ—à–µ–Ω–∏–µ |
|----------|---------|
| `Error calling LLM` | –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `.env`, —É–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –¥–µ–ø–ª–æ–π Azure –∞–∫—Ç–∏–≤–µ–Ω |
| `Milvus connection error` | –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ `milvus_law_rag.db` |
| `CUDA out of memory` | –ú–æ–¥–µ–ª—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—Å—è –Ω–∞ CPU |
| –ù–∏–∑–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ | –£–≤–µ–ª–∏—á—å—Ç–µ `top_k`, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–µ–∂–∏–º `pro` |
| –†–µ–∂–∏–º –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è | –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ë–î –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç `'search'` –≤ `response_type` |

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –û–ø–µ—Ä–∞—Ü–∏—è | –í—Ä–µ–º—è |
|----------|-------|
| –≠–º–±–µ–¥–¥–∏–Ω–≥ –∑–∞–ø—Ä–æ—Å–∞ | ~0.1-0.3 —Å–µ–∫ |
| –ü–æ–∏—Å–∫ –≤ Milvus | ~0.01-0.05 —Å–µ–∫ |
| –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ LLM | ~1-3 —Å–µ–∫ |
| –†–µ–∂–∏–º 'search' | ~0.2-0.5 —Å–µ–∫ |
| –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª (base) | ~2-4 —Å–µ–∫ |
| –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª (pro) | ~4-7 —Å–µ–∫ |
| **–î–æ–∫—É–º–µ–Ω—Ç base** | ~5-10 —Å–µ–∫ |
| **–î–æ–∫—É–º–µ–Ω—Ç pro** | ~15-30 —Å–µ–∫ (–≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑) |

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- ‚ö†Ô∏è –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∫–æ–º–º–∏—Ç—å—Ç–µ `.env` –≤ git
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–æ—Ç–∞—Ü–∏—é API-–∫–ª—é—á–µ–π
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ë–î —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- –í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤:
  - PDF: –º–∞–∫—Å. 20 –ú–ë
  - –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: –º–∞–∫—Å. 10 –ú–ë
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: PDF, JPEG, PNG, GIF, WebP

## üó∫ Roadmap

- [x] Telegram-–±–æ—Ç —Å FSM
- [x] –¢—Ä–∏ —Ä–µ–∂–∏–º–∞ –æ—Ç–≤–µ—Ç–∞ (base, pro, search)
- [x] –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π/—Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤
- [x] –†–∞–±–æ—Ç–∞ —Å —Ñ–∞–π–ª–∞–º–∏ —á–µ—Ä–µ–∑ URL (–±–µ–∑ base64)
- [x] Singleton-–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- [x] LRU-–∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
- [x] –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- [ ] Redis –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–æ–≤
- [ ] Web –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (FastAPI)
- [ ] –ü–æ–¥–¥–µ—Ä–∂–∫–∞ DOCX –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- [ ] A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–µ–π
- [ ] –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–µ–∂–∏–º–æ–≤

## üìÑ –õ–∏—Ü–µ–Ω–∑–∏—è

GNU General Public License v3.0 (GPL-3.0)

–≠—Ç–æ —Å–≤–æ–±–æ–¥–Ω–æ–µ –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–µ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ: –≤—ã –º–æ–∂–µ—Ç–µ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è—Ç—å –∏/–∏–ª–∏ –∏–∑–º–µ–Ω—è—Ç—å –µ–≥–æ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å —É—Å–ª–æ–≤–∏—è–º–∏ GNU General Public License –≤–µ—Ä—Å–∏–∏ 3, –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω–æ–π Free Software Foundation.

–û—Å–Ω–æ–≤–Ω—ã–µ —É—Å–ª–æ–≤–∏—è:
- ‚úÖ –ö–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
- ‚úÖ –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è
- ‚úÖ –†–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ
- ‚úÖ –ü–∞—Ç–µ–Ω—Ç–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
- ‚úÖ –ß–∞—Å—Ç–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
- ‚ùó –†–∞—Å–∫—Ä—ã—Ç–∏–µ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∫–æ–¥–∞ (copyleft)
- ‚ùó –£–∫–∞–∑–∞–Ω–∏–µ –ª–∏—Ü–µ–Ω–∑–∏–∏ –∏ –∞–≤—Ç–æ—Ä—Å–∫–∏—Ö –ø—Ä–∞–≤
- ‚ùó –£–∫–∞–∑–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
- ‚ùó –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–æ–π –∂–µ –ª–∏—Ü–µ–Ω–∑–∏–∏

–°–º. [LICENSE](LICENSE) –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –ª–∏—Ü–µ–Ω–∑–∏–∏.

## üë§ –ê–≤—Ç–æ—Ä

**Askat Rakhymbekov** ([@Hanbiike](https://github.com/Hanbiike))

## üôè –ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏

- Azure OpenAI ‚Äî LLM –º–æ–¥–µ–ª–∏
- Milvus ‚Äî –≤–µ–∫—Ç–æ—Ä–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- SentenceTransformers ‚Äî —ç–º–±–µ–¥–¥–∏–Ω–≥–∏
- aiogram ‚Äî Telegram-–±–æ—Ç —Ñ—Ä–µ–π–º–≤–æ—Ä–∫